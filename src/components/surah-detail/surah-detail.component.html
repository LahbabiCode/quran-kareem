@if(surahInfo(); as surah) {
<div class="space-y-8">
  <header class="p-6 bg-slate-900 border border-slate-800 rounded-xl relative">
    <button (click)="toggleCurrentSurahFavorite()" class="absolute top-4 right-4 rtl:right-auto rtl:left-4 p-2 rounded-full text-slate-400 hover:bg-slate-700 transition-colors z-10" [title]="isCurrentSurahFavorite()() ? t('Remove from favorites')() : t('Add to favorites')()">
        @if(isCurrentSurahFavorite()()) {
          <app-star-solid-icon class="text-yellow-500"></app-star-solid-icon>
        } @else {
          <app-star-icon class="hover:text-yellow-500"></app-star-icon>
        }
    </button>
    <div class="text-center">
        <h1 class="text-4xl font-amiri text-teal-400">{{ surah.arabicName }}</h1>
        <h2 class="text-2xl text-slate-200">{{ surah.englishName }}</h2>
    </div>
    
    <!-- Surah Info Grid -->
    <div class="mt-6 pt-4 border-t border-slate-700 grid grid-cols-1 sm:grid-cols-3 gap-4 text-center sm:text-left">
        <div>
            <p class="text-sm text-slate-400">{{ t('Translated Name')() }}</p>
            <p class="font-semibold text-slate-200">"{{ surah.englishNameTranslation }}"</p>
        </div>
        <div class="sm:text-center">
            <p class="text-sm text-slate-400">{{ t('Revelation Place')() }}</p>
            <p class="font-semibold text-slate-200">{{ getRevelationType(surah.revelationType) }}</p>
        </div>
        <div class="sm:text-right">
            <p class="text-sm text-slate-400">{{ t('Number of Verses')() }}</p>
            <p class="font-semibold text-slate-200">{{ surah.numberOfAyahs }} {{ t('Ayahs')() }}</p>
        </div>
    </div>

    <!-- Actions -->
    <div class="mt-6 pt-4 border-t border-slate-700 flex items-center justify-center gap-4">
        <button (click)="playSurah()" class="px-6 py-3 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors font-semibold shadow-lg hover:shadow-teal-500/30 transform hover:scale-105 active:scale-100 flex-grow sm:flex-grow-0">
          <div class="flex items-center justify-center gap-2">
            <app-play-icon [size]="5"></app-play-icon>
            <span>{{ t('Play Surah')() }}</span>
          </div>
        </button>
        <button (click)="isSettingsModalOpen.set(true)" class="p-3 bg-slate-800/50 border border-slate-700 text-slate-300 rounded-lg hover:bg-slate-700 transition-colors" [title]="t('Settings')()">
            <app-cog-icon></app-cog-icon>
        </button>
    </div>
  </header>
  

  <!-- Ayahs List -->
  <div class="space-y-1">
    @if (!ayahs().length) {
      <div class="flex justify-center items-center py-10">
        <app-loading-spinner></app-loading-spinner>
      </div>
    } @else {
      @for (ayah of ayahs(); track ayah.number) {
        @let isPlayingAyah = playingAyahNumberInSurah() === ayah.numberInSurah;
        <div 
            [id]="'ayah-' + surah.id + '-' + ayah.numberInSurah" 
            class="p-4 rounded-md border-b border-slate-800 last:border-b-0 transition-all duration-300 border-l-4" 
            [class.bg-teal-900/20]="isPlayingAyah"
            [class.border-teal-500]="isPlayingAyah"
            [class.border-transparent]="!isPlayingAyah">
          <div class="flex justify-between items-start gap-4">
            <div class="flex items-center gap-3">
              <span class="text-sm font-semibold text-teal-400 bg-slate-800 px-2 py-1 rounded-md select-none">
                {{ surah.id }}:{{ ayah.numberInSurah }}
              </span>
              @if(isPlayingAyah) {
                <app-sound-wave-icon class="text-teal-400"></app-sound-wave-icon>
              }
            </div>
            <div class="flex items-center gap-1">
              <button (click)="shareAyah(ayah)" [title]="t('Share Ayah')()" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 hover:text-cyan-400 transition-colors relative">
                @if (copiedAyahKey() === surah.id + ':' + ayah.numberInSurah) {
                  <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-700 text-white text-xs px-2 py-1 rounded-md shadow-lg whitespace-nowrap">
                    {{ t('Copied to clipboard!')() }}
                  </span>
                }
                @if (copyErrorAyahKey() === surah.id + ':' + ayah.numberInSurah) {
                  <span class="absolute -top-8 left-1/2 -translate-x-1/2 bg-red-700 text-white text-xs px-2 py-1 rounded-md shadow-lg whitespace-nowrap">
                    {{ t('Could not copy.')() }}
                  </span>
                }
                <app-share-icon></app-share-icon>
              </button>
              <button (click)="askAI(ayah)" [title]="t('Ask AI')()" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 hover:text-purple-400 transition-colors">
                <app-sparkle-icon></app-sparkle-icon>
              </button>
              <button (click)="toggleTafsirVisibility(ayah.numberInSurah!)" [title]="t('Tafsir')()" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 hover:text-blue-400 transition-colors">
                <app-book-open-icon></app-book-open-icon>
              </button>
              <button (click)="toggleAyahFavorite(ayah.numberInSurah!)" [title]="isAyahFavorite(ayah.numberInSurah!)() ? t('Remove from favorites')() : t('Add to favorites')()" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 transition-colors">
                  @if(isAyahFavorite(ayah.numberInSurah!)()) {
                    <app-star-solid-icon class="text-yellow-500"></app-star-solid-icon>
                  } @else {
                    <app-star-icon class="hover:text-yellow-500"></app-star-icon>
                  }
              </button>
              <button (click)="toggleAyahBookmark(ayah.numberInSurah!)" [title]="isAyahBookmarked(ayah.numberInSurah!)() ? t('Remove from bookmarks')() : t('Add to bookmarks')()" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 transition-colors">
                  @if(isAyahBookmarked(ayah.numberInSurah!)()) {
                    <app-bookmark-solid-icon class="text-indigo-400"></app-bookmark-solid-icon>
                  } @else {
                    <app-bookmark-icon [customClass]="'w-5 h-5 hover:text-indigo-400'"></app-bookmark-icon>
                  }
              </button>
               @if (playbackMode() === 'ayah') {
                <button (click)="playAyah(ayah.numberInSurah!)" [title]="'Play Ayah ' + ayah.numberInSurah" class="p-2 rounded-full text-slate-400 hover:bg-slate-700 hover:text-green-400 transition-colors">
                  @if(isPlayingAyah) {
                    <app-pause-icon [size]="5"></app-pause-icon>
                  } @else {
                    <app-play-icon [size]="5"></app-play-icon>
                  }
                </button>
              }
            </div>
          </div>
          <div class="mt-4 space-y-6">
            @if(isWordByWordEnabled() && ayah.words?.length) {
              <div class="flex flex-wrap-reverse justify-end items-start gap-y-6" (click)="activeWord.set(null)">
                @for(word of ayah.words; track word.id) {
                  <div 
                    class="relative inline-flex flex-col items-center p-2 rounded-md cursor-pointer transition-colors hover:bg-slate-700/50"
                    (click)="$event.stopPropagation(); toggleActiveWord(ayah.numberInSurah!, word.position)">
                    
                    <span class="text-3xl font-amiri text-slate-100 mb-1">{{ word.text }}</span>
                    
                    @if (activeWord()?.ayahNum === ayah.numberInSurah && activeWord()?.wordPos === word.position) {
                      <div class="absolute top-full left-1/2 -translate-x-1/2 mt-2 w-max max-w-xs z-10 p-3 bg-slate-900 border border-slate-600 rounded-lg shadow-xl text-center">
                          <p class="text-teal-300 font-semibold">{{ word.translation.text }}</p>
                          <p class="text-slate-400 text-sm italic">{{ word.transliteration.text }}</p>
                      </div>
                    }
                  </div>
                }
              </div>
            } @else {
              @if(translationView() === 'arabic' || translationView() === 'english') {
                <p class="text-4xl lg:text-5xl font-amiri leading-loose rtl:leading-[3.5rem] text-right text-slate-100" [dir]="languageService.direction() === 'rtl' ? 'rtl' : 'ltr'">
                  {{ ayah.text }}
                </p>
              }
            }
            
            @if(translationView() === 'english' && ayah.translation) {
              <p class="text-lg text-slate-300 leading-relaxed" [dir]="'ltr'">
                {{ ayah.numberInSurah }}. {{ ayah.translation }}
                <span class="block text-sm text-slate-400 mt-1 italic">{{ ayah.transliteration }}</span>
              </p>
            }
            @if(isTafsirVisible(ayah.numberInSurah!) && tafsirMap().has(ayah.numberInSurah!)) {
              @let tafsir = selectedTafsir();
              <div class="mt-2 p-3 bg-slate-800 text-slate-300 text-sm border-blue-500"
                  [class.border-l-4]="tafsir?.language_name !== 'arabic'"
                  [class.border-r-4]="tafsir?.language_name === 'arabic'">
                <p [innerHTML]="tafsirMap().get(ayah.numberInSurah!)"
                    [dir]="tafsir?.language_name === 'arabic' ? 'rtl' : 'ltr'"
                    [class.font-amiri]="tafsir?.language_name === 'arabic'"
                    [class.text-right]="tafsir?.language_name === 'arabic'">
                </p>
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

</div>

<!-- AI Explanation Modal -->
<app-modal [isOpen]="isAiModalOpen()" (closeModal)="isAiModalOpen.set(false)">
  <div slot="title">{{ t('AI Explanation')() }}</div>
  <div slot="content">
    @if(isAiLoading()) {
      <div class="flex flex-col items-center justify-center gap-4 p-8">
          <app-loading-spinner></app-loading-spinner>
          <p class="text-slate-600">{{ t('Generating explanation...')() }}</p>
      </div>
    } @else if (aiError()) {
      <p class="text-red-600">{{ aiError() }}</p>
    } @else {
      <div class="prose-slate" [innerHTML]="formattedAiExplanation()"></div>
    }
  </div>
  <div slot="close-button-text">{{ t('Close')() }}</div>
</app-modal>

<!-- Settings Modal -->
<app-modal [isOpen]="isSettingsModalOpen()" (closeModal)="isSettingsModalOpen.set(false)">
  <div slot="title">{{ t('Settings')() }}</div>
  <div slot="content">
    <div class="space-y-4">
      <!-- Playback Mode Toggle -->
      <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">{{ t('Playback Mode')() }}</label>
          <div class="flex w-full bg-slate-900 rounded-lg p-1">
              <button (click)="setPlaybackMode('ayah')" class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors" [class.bg-slate-700]="playbackMode() === 'ayah'" [class.text-teal-400]="playbackMode() === 'ayah'" [class.text-slate-300]="playbackMode() !== 'ayah'">{{ t('By Ayah')() }}</button>
              <button (click)="setPlaybackMode('surah')" class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors" [class.bg-slate-700]="playbackMode() === 'surah'" [class.text-teal-400]="playbackMode() === 'surah'" [class.text-slate-300]="playbackMode() !== 'surah'">{{ t('Full Surah')() }}</button>
          </div>
      </div>

      <!-- Reciter Select -->
      <div>
        <label for="reciter-select" class="block text-sm font-medium text-slate-300 mb-2">{{ t('Select Reciter')() }}</label>
        <select 
          id="reciter-select" 
          (change)="selectReciter($event.target.value)"
          [value]="playbackMode() === 'ayah' ? selectedPerAyahReciter()?.id : selectedFullSurahReciter()?.id"
          class="w-full p-2 bg-slate-900 border border-slate-600 text-slate-200 rounded-md focus:ring-teal-500 focus:border-teal-500">
          <option value="">-- {{ t('Select Reciter')() }} --</option>
          @if (playbackMode() === 'ayah') {
              @for(reciter of perAyahReciters(); track reciter.id) {
              <option [value]="reciter.id">{{ reciter.name }} ({{ reciter.rewaya }} - {{ reciter.quality }})</option>
              }
          } @else {
              @for(reciter of recitersForSurahMode(); track reciter.id) {
              <option [value]="reciter.id">{{ reciter.name }} ({{ reciter.rewaya }})</option>
              }
          }
        </select>
      </div>

      <!-- Word by Word Toggle -->
      <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">{{ t('Word by Word')() }}</label>
          <div class="flex w-full bg-slate-900 rounded-lg p-1">
              <button (click)="isWordByWordEnabled.set(false); activeWord.set(null)" class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors" [class.bg-slate-700]="!isWordByWordEnabled()" [class.text-teal-400]="!isWordByWordEnabled()" [class.text-slate-300]="isWordByWordEnabled()">{{ t('Off')() }}</button>
              <button (click)="isWordByWordEnabled.set(true); activeWord.set(null)" class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors" [class.bg-slate-700]="isWordByWordEnabled()" [class.text-teal-400]="isWordByWordEnabled()" [class.text-slate-300]="!isWordByWordEnabled()">{{ t('On')() }}</button>
          </div>
      </div>

      <!-- Translation Select -->
      <div>
          <label for="translation-select" class="block text-sm font-medium text-slate-300 mb-2">{{ t('Translation Source')() }}</label>
          <select 
            id="translation-select" 
            (change)="selectTranslation($event)"
            [value]="selectedTranslationId()"
            class="w-full p-2 bg-slate-900 border border-slate-600 text-slate-200 rounded-md focus:ring-teal-500 focus:border-teal-500">
            <option value="0">{{ t('None')() }}</option>
            @for(translation of availableTranslations(); track translation.id) {
              <option [value]="translation.id">{{ translation.name }} ({{ translation.language_name }})</option>
            }
          </select>
      </div>

      <!-- Tafsir Select -->
      <div>
          <label for="tafsir-select" class="flex items-center gap-2 text-sm font-medium text-slate-300 mb-2">
            <span>{{ t('Tafsir')() }}</span>
            @if (isTafsirLoading()) {
              <app-loading-spinner customClass="h-4 w-4"></app-loading-spinner>
            }
          </label>
          <select id="tafsir-select" (change)="selectTafsir($event.target.value)" class="w-full p-2 bg-slate-900 border border-slate-600 text-slate-200 rounded-md focus:ring-teal-500 focus:border-teal-500 disabled:opacity-50" [disabled]="isTafsirLoading()">
            <option value="">-- {{ t('Select Tafsir')() }} --</option>
            @for(tafsir of tafsirList(); track tafsir.id) {
              @let details = [
                (tafsir.arabicName && tafsir.arabicName !== tafsir.name ? tafsir.arabicName : null),
                tafsir.quality
              ].filter(Boolean).join(', ');
              <option [value]="tafsir.id">
                {{ tafsir.name }}
                @if (details) {
                  ({{ details }})
                }
              </option>
            }
          </select>
      </div>
      
      <!-- Translation View Toggle -->
      <div>
          <label class="block text-sm font-medium text-slate-300 mb-2">{{ t('Translation View')() }}</label>
          <div class="flex w-full bg-slate-900 rounded-lg p-1">
              <button (click)="setTranslationView('arabic')" class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors" [class.bg-slate-700]="translationView() === 'arabic'" [class.text-teal-400]="translationView() === 'arabic'" [class.text-slate-300]="translationView() !== 'arabic'">{{ t('Arabic')() }}</button>
              <button (click)="setTranslationView('english')" class="w-1/2 p-2 rounded-md text-sm font-semibold transition-colors" [class.bg-slate-700]="translationView() === 'english'" [class.text-teal-400]="translationView() === 'english'" [class.text-slate-300]="translationView() !== 'english'">{{ t('English')() }}</button>
          </div>
      </div>

      <!-- Jump to Ayah -->
      <div>
          <label for="jump-to-ayah" class="block text-sm font-medium text-slate-300 mb-2">{{ t('Jump to Ayah')() }}</label>
          <div class="flex items-center gap-2">
              <input 
                #ayahInput
                type="number" 
                id="jump-to-ayah"
                [placeholder]="'1-' + surah.numberOfAyahs"
                min="1"
                [max]="surah.numberOfAyahs"
                class="w-full p-2 bg-slate-900 border border-slate-600 text-slate-200 rounded-md focus:ring-teal-500 focus:border-teal-500"
                (keydown.enter)="jumpToAyah(ayahInput.value)"
              />
              <button (click)="jumpToAyah(ayahInput.value)" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors">
                {{ t('Go')() }}
              </button>
          </div>
      </div>
    </div>
  </div>
  <div slot="close-button-text">{{ t('Close')() }}</div>
</app-modal>

} @else {
  <div class="flex justify-center items-center py-20">
    <app-loading-spinner></app-loading-spinner>
  </div>
}
